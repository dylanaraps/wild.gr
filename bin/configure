#
# This file was generated by bin/configure.
#
# Copyright 2025-2026 - Dylan Araps - All Rights Reserved
#
!!
. ./config

for d in "$SITE_ASS_DIR/"*/ ${SITE_LANG#* }; do
  [ ! -d "$d" ] || mkdir -p "$SITE_PUB_DIR/${d#"$SITE_ASS_DIR/"}"
done
echo ".ninja_*
$SITE_NINJA_FILE" > .gitignore

# TODO: TEMPORARY
echo "$SITE_ASS_DIR/*.jpg
$SITE_ASS_DIR/*/*.jpg" >> .gitignore
echo "${SITE_URL#https://}" > "$SITE_PUB_DIR/CNAME"
!!

dpp_cmd = \
  DPP_BLOCK="$SITE_DPP_BLOCK" \
  DPP_INCLUDE="$SITE_DPP_INCLUDE" \
  $SITE_DPP_PROG

rule doc
  command = DPP_FILE="\$out" DPP_CAT="$SITE_DPP_CAT" \$dpp_cmd < \$in | $SITE_MINIFY_CMD > \$out
  description = dpp \$in \$out

rule css
  command = DPP_FILE="\$in" \$dpp_cmd < \$in | $SITE_CSS_CMD > \$out
  description = css \$in \$out

rule xml
  command = \
    DPP_BLOCK="$SITE_DPP_BLOCK" \
    DPP_CAT="$SITE_DPP_CAT" \
    DPP_INCLUDE="$SITE_DPP_INCLUDE" \
    DPP_FILE="\$in" \
    $SITE_DPP_PROG < \$in > \$out
  description = dpp \$in \$out

rule jpg
  command = \
    $SITE_MAGICK_CMD \$in \
    -resize \${s}x \
    $SITE_MAGICK_COMMON \
    $SITE_MAGICK_JPEG \
    \$out
  description = jpg \$in \$out

rule webp
  command = \
    $SITE_CWEBP_CMD \$in \
    -resize \$s \
    $SITE_CWEBP_OPT \
    -o \$out
  description = webp \$in \$out

rule svg
  command = $SITE_OXVG_CMD \$in > \$out
  description = svg \$in \$out

rule png
  command = $SITE_OXIPNG_CMD \$in --out \$out
  description = png \$in \$out

rule ico
  command = $SITE_MAGICK_CMD \$in \$out
  description = ico \$in \$out

rule lnk
  command = cp -f \$in \$out

#
# Generate a file containing the most dominant color in an image file for use as
# a placeholder while the image loads.
#
rule clr
  command = \
    $SITE_MAGICK_CMD \$in \
    -scale 128x \
    -kmeans 10 \
    -format %c \
    histogram:info: | sed 's/.*#//g;s/ .*//g;2q;d' > \$out
  description = clr \$in \$out

build $SITE_PUB_DIR/$SITE_STYLE: css $SITE_STYLE
build $SITE_PUB_DIR/favicon.ico: ico $SITE_PUB_DIR/favicon.png

!!
find . \
  -path "./${SITE_PUB_DIR#./}"      -prune -o \
  -path "./${SITE_TPL_DIR#./}" -prune -o \
  -type f -name \*.html -print | while IFS= read -r p; do
  n=${p#./}
  echo "build $SITE_PUB_DIR/$n: doc $n |" \
    "$SITE_PUB_DIR/$SITE_STYLE" \
    $SITE_TPL_DIR/*.html \
    "${SITE_DPP_INCLUDE:-} config $*" \
    "$SITE_PUB_DIR/favicon."ico \
    "$SITE_LANG_TEXT"
done

find . -name \*.md | while IFS= read -r p; do
  case $p in *README.md) continue; esac
  src "$p"
  n=${p#./}

  for l in $SITE_LANG; do
    l=${l#${SITE_LANG%" ${SITE_LANG#* }"}}
    echo "build $SITE_PUB_DIR${l:+"/$l"}/${n%.md}.html: doc $n |" \
      "$SITE_PUB_DIR/$SITE_STYLE" \
      $SITE_TPL_DIR/*.html \
      "${SITE_DPP_INCLUDE:-} config $*" \
      "$SITE_PUB_DIR/favicon."ico \
      "$SITE_LANG_TEXT"
  done
done

for p in *.pre.xml; do
  n=${p#$SITE_ASS_DIR/}
  echo build "$SITE_PUB_DIR/${n%.pre.xml}.xml: xml $p |" \
    ${SITE_DPP_INCLUDE:-} config *.md
done

find "$SITE_ASS_DIR/" -type f | while IFS= read -r p; do case $p in
  *.jpg)
    n=${p#$SITE_ASS_DIR/}
    n=${n%.jpg}

    for s in $SITE_IMG_SIZES; do
      for f in ${SITE_IMG_FMT:-jpg}; do
        case $f$p in 
          webp*v.jpg) _o="0 $s" ;;
           webp*.jpg) _o="$s 0" ;;
                   *) _o="$s"   ;;
        esac

        echo "build $SITE_PUB_DIR/$n-$s.$f: $f $p\\n  s = $_o"
      done
    done

    echo "build $SITE_PUB_DIR/$n.clr: clr" \
      "$SITE_PUB_DIR/$n-${SITE_IMG_SIZES##* }.jpg"
  ;;

  *.png)
    echo build "$SITE_PUB_DIR/${p#$SITE_ASS_DIR/}": png "$p"
  ;;

  *.svg)
    echo build "$SITE_PUB_DIR/${p#$SITE_ASS_DIR/}": svg "$p"
  ;;

  *)
    echo build "$SITE_PUB_DIR/${p#$SITE_ASS_DIR/}": lnk "$PWD/$p"
  ;;
esac done
!!

